<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Salut üëã - Vitrine </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0F172A; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .coin-glow { filter: drop-shadow(0 0 10px rgba(234, 179, 8, 0.5)); }
    </style>
</head>
<body class="text-white min-h-screen pb-32">

    <!-- Header -->
    <header class="p-6 sticky top-0 z-50 glass rounded-b-[2.5rem] shadow-2xl">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="font-black italic text-lg tracking-tighter">KERYAN_OS</h1>
                <p id="tab-indicator" class="text-[9px] text-indigo-400 font-bold uppercase tracking-[0.3em] mt-0.5">Missions</p>
            </div>
            <div class="bg-yellow-400/10 border border-yellow-400/20 px-5 py-2.5 rounded-2xl flex items-center gap-2">
                <span id="coins" class="text-3xl font-black text-yellow-500 coin-glow">0</span>
                <i data-lucide="star" class="text-yellow-400 fill-yellow-400 w-6 h-6"></i>
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto px-6 mt-6">
        
        <!-- Notif -->
        <div id="notif" class="hidden fixed top-24 left-1/2 -translate-x-1/2 z-[60] bg-indigo-500 px-6 py-3 rounded-full font-bold shadow-2xl border border-white/20 text-sm whitespace-nowrap"></div>

        <!-- Mode Boost -->
        <div id="boost-status" class="hidden mb-6 bg-gradient-to-r from-orange-500 to-rose-600 p-4 rounded-3xl flex justify-between items-center shadow-lg border border-white/10 animate-pulse">
            <div class="flex items-center gap-3">
                <i data-lucide="zap" class="fill-white w-6 h-6"></i>
                <div>
                    <p class="font-black text-xs uppercase tracking-tighter">√ânergie Boost Active !</p>
                    <p id="timer" class="text-[10px] font-bold opacity-80 tabular-nums">--:-- restant</p>
                </div>
            </div>
            <span id="mult-badge" class="bg-white/20 px-3 py-1 rounded-xl font-black text-xs">x2</span>
        </div>

        <!-- ONGLET : MISSIONS -->
        <div id="tab-missions" class="tab-content active space-y-4">
            <div id="missions-list" class="space-y-3"></div>
        </div>

        <!-- ONGLET : R√âCOMPENSES (OBJETS) -->
        <div id="tab-rewards" class="tab-content space-y-4">
            <div id="rewards-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <!-- ONGLET : BOOSTS -->
        <div id="tab-boosts" class="tab-content">
            <div id="boosts-list" class="grid grid-cols-2 gap-4"></div>
        </div>

        <!-- ONGLET : CODES -->
        <div id="tab-codes" class="tab-content space-y-6">
            <div class="bg-slate-800/60 p-8 rounded-[3rem] border border-white/5 space-y-5 text-center shadow-xl shadow-indigo-500/10">
                <div class="w-16 h-16 bg-emerald-500/10 rounded-3xl flex items-center justify-center mx-auto text-emerald-400 mb-2">
                    <i data-lucide="ticket" size="32"></i>
                </div>
                <h2 class="font-black text-xs uppercase tracking-[0.2em] text-slate-400">Entrer un Code Secret</h2>
                <input id="codeInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-slate-900 border-none p-5 rounded-3xl text-center font-black text-2xl uppercase tracking-[0.4em] outline-none ring-4 ring-indigo-500/10 focus:ring-indigo-500/40 transition-all placeholder:opacity-20">
                <button onclick="redeemCode()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-5 rounded-3xl font-black shadow-xl shadow-indigo-500/30 transition-all active:scale-95 uppercase tracking-widest text-sm">Activer le Tr√©sor</button>
            </div>
        </div>

        <!-- ONGLET : COFFRE -->
        <div id="tab-chest" class="tab-content text-center">
            <div class="bg-gradient-to-br from-indigo-600 to-indigo-900 p-10 rounded-[3.5rem] shadow-2xl relative overflow-hidden group border border-white/10">
                <i data-lucide="gem" class="w-48 h-48 absolute -right-8 -bottom-8 text-white/5 -rotate-12 group-hover:rotate-6 transition-all duration-1000"></i>
                <div class="relative z-10">
                    <div id="chest-icon-box" class="w-24 h-24 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner animate-bounce">
                        <i data-lucide="gift" class="w-12 h-12 text-yellow-400"></i>
                    </div>
                    <p id="chest-status" class="font-black text-2xl mb-8 leading-tight">V√©rification du coffre...</p>
                    <button id="chest-btn" onclick="openChest()" class="hidden w-full bg-yellow-400 text-slate-900 py-5 rounded-3xl font-black text-lg shadow-xl shadow-yellow-500/40 hover:scale-105 active:scale-90 transition-all uppercase tracking-widest">Ouvrir Maintenant</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 inset-x-0 glass border-t border-white/5 p-4 flex justify-around rounded-t-[3rem] shadow-[0_-10px_40px_rgba(0,0,0,0.4)] z-[100]">
        <button onclick="switchTab('missions')" class="nav-btn flex flex-col items-center gap-1.5 text-indigo-500 transition-all duration-300" data-tab="missions">
            <i data-lucide="clipboard-list"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter">Missions</span>
        </button>
        <button onclick="switchTab('rewards')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-500 transition-all duration-300" data-tab="rewards">
            <i data-lucide="shopping-cart"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter">Boutique</span>
        </button>
        <button onclick="switchTab('boosts')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-500 transition-all duration-300" data-tab="boosts">
            <i data-lucide="flame"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter">Boosts</span>
        </button>
        <button onclick="switchTab('codes')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-500 transition-all duration-300" data-tab="codes">
            <i data-lucide="key"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter">Codes</span>
        </button>
        <button onclick="switchTab('chest')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-500 transition-all duration-300" data-tab="chest">
            <i data-lucide="package"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter">Coffre</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAoi_kyX6lYO3mI86ntSfASr6MbJtNg9bM",
            authDomain: "missions-f7532.firebaseapp.com",
            projectId: "missions-f7532",
            storageBucket: "missions-f7532.firebasestorage.app",
            messagingSenderId: "421662144044",
            appId: "1:421662144044:web:e706da72fef10c60e44389"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const docRef = doc(db, "global", "state");

        let currentBoost = { multiplier: 1, expires: 0 };

        async function init() {
            await signInAnonymously(auth);
            onSnapshot(docRef, (snap) => {
                if (!snap.exists()) return;
                render(snap.data());
            });
            setInterval(tick, 1000);
        }

        function render(data) {
            document.getElementById('coins').innerText = data.coins || 0;
            currentBoost = data.boost || { multiplier: 1, expires: 0 };
            const now = Date.now();
            const multiplier = currentBoost.expires > now ? currentBoost.multiplier : 1;

            // Status Boost
            const bBox = document.getElementById('boost-status');
            if (multiplier > 1) {
                bBox.classList.remove('hidden');
                document.getElementById('mult-badge').innerText = `x${multiplier}`;
            } else bBox.classList.add('hidden');

            // Missions
            const mList = document.getElementById('missions-list');
            mList.innerHTML = (data.missions || []).map((m, i) => `
                <div class="bg-slate-800 border border-white/5 p-5 rounded-[2.5rem] flex justify-between items-center group shadow-xl">
                    <div>
                        <p class="font-black text-xs uppercase tracking-tight text-indigo-300 mb-1">${m.name}</p>
                        <p class="text-yellow-500 font-black text-xl italic">${m.value * multiplier} ‚≠ê</p>
                    </div>
                    <button onclick="doMission(${i})" class="bg-indigo-600 p-4 rounded-3xl shadow-lg shadow-indigo-600/30 active:scale-90 transition-all">
                        <i data-lucide="rocket" size="20" class="fill-white"></i>
                    </button>
                </div>
            `).join('') || '<p class="text-slate-600 text-center py-10 italic">Aucune mission disponible !</p>';

            // R√©compenses (Boutique)
            const rGrid = document.getElementById('rewards-grid');
            rGrid.innerHTML = (data.rewards || []).map((r, i) => `
                <div class="bg-slate-800/80 p-4 rounded-[2.5rem] border border-white/5 flex flex-col shadow-lg">
                    <div class="aspect-square bg-slate-900 rounded-2xl mb-4 overflow-hidden shadow-inner">
                        <img src="${r.img || 'https://via.placeholder.com/150?text=Object'}" class="w-full h-full object-cover">
                    </div>
                    <p class="font-black text-[10px] uppercase tracking-tighter mb-1">${r.name}</p>
                    <div class="mt-auto">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-rose-400 font-black text-sm">${r.price} ‚≠ê</span>
                            <span class="text-[8px] bg-white/10 px-2 py-0.5 rounded-full">STOCK: ${r.stock}</span>
                        </div>
                        <button onclick="buyReward(${i})" ${data.coins < r.price || r.stock <= 0 ? 'disabled' : ''} class="w-full bg-rose-600 disabled:bg-slate-700 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all active:scale-95">
                            Acheter
                        </button>
                    </div>
                </div>
            `).join('');

            // Boosters
            const bList = document.getElementById('boosts-list');
            bList.innerHTML = (data.boosts || []).map((b, i) => `
                <div class="bg-indigo-600/20 p-5 rounded-[2.5rem] border border-indigo-500/20 text-center shadow-lg">
                    <div class="text-2xl font-black italic text-indigo-400 mb-1">X${b.multiplier}</div>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-4">${b.duration} Minutes</p>
                    <button onclick="buyBoost(${i})" ${data.coins < b.price ? 'disabled' : ''} class="w-full bg-indigo-600 disabled:bg-slate-700 py-2.5 rounded-2xl font-black text-[10px] uppercase">
                        ${b.price} ‚≠ê
                    </button>
                </div>
            `).join('');

            // Chest
            const cBtn = document.getElementById('chest-btn');
            const cStatus = document.getElementById('chest-status');
            if (now >= (data.chest?.next || 0)) {
                cStatus.innerHTML = `Ton Tr√©sor : <br><span class="text-yellow-400 text-4xl font-black">${data.chest.reward * multiplier} ‚≠ê</span>`;
                cBtn.classList.remove('hidden');
            } else {
                const diff = data.chest.next - now;
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                cStatus.innerText = `Reviens dans ${h}h et ${m}m pour ton cadeau.`;
                cBtn.classList.add('hidden');
            }

            lucide.createIcons();
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.replace('text-indigo-500', 'text-slate-500'));
            document.querySelector(`[data-tab="${tab}"]`).classList.replace('text-slate-500', 'text-indigo-500');
            document.getElementById('tab-indicator').innerText = tab;
        };

        window.doMission = async (i) => {
            const snap = await getDoc(docRef);
            const data = snap.data();
            const missions = [...data.missions];
            const task = missions.splice(i, 1)[0];
            const mult = currentBoost.expires > Date.now() ? currentBoost.multiplier : 1;
            const pending = data.pending || [];
            pending.push({ ...task, boost: mult });
            await updateDoc(docRef, { missions, pending });
            showNotif("Mission envoy√©e au Studio ! ‚ú®");
        };

        window.buyReward = async (i) => {
            const snap = await getDoc(docRef);
            const data = snap.data();
            const item = data.rewards[i];
            if (data.coins >= item.price && item.stock > 0) {
                const rewards = [...data.rewards];
                rewards[i].stock -= 1;
                await updateDoc(docRef, { coins: data.coins - item.price, rewards });
                showNotif("Achat valid√© ! Trop cool ! üéÅ");
            }
        };

        window.redeemCode = async () => {
            const val = document.getElementById('codeInput').value.toUpperCase();
            if (!val) return;
            const snap = await getDoc(docRef);
            const data = snap.data();
            const codes = [...(data.codes || [])];
            const idx = codes.findIndex(c => c.key === val);
            if (idx > -1) {
                const mult = currentBoost.expires > Date.now() ? currentBoost.multiplier : 1;
                const gain = codes[idx].val * mult;
                codes.splice(idx, 1);
                await updateDoc(docRef, { coins: (data.coins || 0) + gain, codes });
                showNotif(`CODE VALIDE ! +${gain} ‚≠ê`);
                document.getElementById('codeInput').value = "";
            } else showNotif("Code incorrect... Recommence ! ‚ùå");
        };

        window.buyBoost = async (i) => {
            const snap = await getDoc(docRef);
            const data = snap.data();
            const b = data.boosts[i];
            if (data.coins >= b.price) {
                await updateDoc(docRef, {
                    coins: data.coins - b.price,
                    boost: { multiplier: b.multiplier, expires: Date.now() + (b.duration * 60000) }
                });
                showNotif("BOOST ACTIV√â ! üî•");
                switchTab('missions');
            }
        };

        window.openChest = async () => {
            const snap = await getDoc(docRef);
            const data = snap.data();
            const mult = currentBoost.expires > Date.now() ? currentBoost.multiplier : 1;
            const reward = data.chest.reward * mult;
            await updateDoc(docRef, {
                coins: (data.coins || 0) + reward,
                "chest.next": Date.now() + (24 * 3600000)
            });
            showNotif(`INCROYABLE ! +${reward} ‚≠ê !`);
        };

        function tick() {
            if (currentBoost.expires > Date.now()) {
                const diff = currentBoost.expires - Date.now();
                const m = Math.floor(diff / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s} restant`;
            }
        }

        function showNotif(txt) {
            const n = document.getElementById('notif');
            n.innerText = txt;
            n.classList.remove('hidden');
            setTimeout(() => n.classList.add('hidden'), 3500);
        }

        init();
    </script>
</body>
</html>
